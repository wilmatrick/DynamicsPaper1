\subsection{Fitting procedure} \label{sec:fitting}

To search the $(p_\Phi,p_\text{DF})$ parameter space for the maximum of the \pdf{} in Equation \ref{eq:prob}, we go beyond the single fixed grid search by BR13 and employ an effective two-step procedure: Nested-grid search and Monte-Carlo Markov Chain.

The first step employs a nested-grid search to find the approximate peak and width of the \pdf{} in the high-dimensional \pmodel{}  space at a low number of likelihood evaluations:

\begin{itemize}
\item \emph{Initialization.} For $N_p$ free model parameters \pmodel{} we start with a sufficiently large grid with $3^{N_p}$ regular points.

\item  \emph{Evaluation.} We evaluate the \pdf{} at each grid-point similar to BR13 (their Figure 9):  An outer loop iterates over the potential parameters $p_\Phi$ and pre-calculates all $N_* \times N_\text{samples} + N_x^2 \times N_v^3$ actions required for the likelihood calculation (see Equations \ref{eq:tracerdensity}, \ref{eq:prob} and \ref{eq:errorconv}). Then an inner loop evaluates Equation \ref{eq:prob} (or \ref{eq:errorconv}) for all DF parameters $p_\text{DF}$ in the given potential.

\item \emph{Iteration.} For each of the model parameters \pmodel{} we marginalize the \pdf{}. A Gaussian is fitted to the marginalized \pdf{} and the peak $\pm ~ 4$ sigma become the boundaries of the next grid with $3^{N_p}$ grid points. The grid might be still too coarse or badly positioned to fit Gaussians. In that case we either zoom into the grid point with the highest probability or shift the current range to find new approximate grid boundaries. We proceed with iteratively evaluating the \pdf{} on finer and finer grids, until we have found a reliable 4-sigma fit range in each of the \pmodel{} dimensions. The central grid point is then very close to the best fit \pmodel{}, and the grid range is of the order of the \pdf{} width.

\item \emph{The fiducial qDF.} To save time by pre-calculating actions, they have to be independent of the choice of $p_\text{DF}$. However, the normalisation in Equation \ref{eq:normalisation} requires actions on a $N_x^2 \times N_v^3$ grid and the grid ranges in velocity space \emph{do} depend on the current $p_\text{DF}$ (see Equation \ref{eq:tracerdensity}). To relax this, we follow BR13 and use a fixed set of qDF parameters (the \emph{fiducial qDF}) to set the velocity grid boundaries in Equation \ref{eq:tracerdensity} globally for a given $p_\Phi$. Choosing a fiducial qDF that is very different from the true DF can however lead to large biases in the \pmodel{} recovery. BR13 did not account for that. \RM{} avoids this as follows: To get successively closer to the optimal fiducial qDF---with the (yet unknown) best fit $p_\text{DF}$---we use in each iteration step of the nested-grid search the central grid point of the current \pmodel{} grid as the fiducial qDF's $p_\text{DF}$.  As the nested-grid search approaches the best fit values, the fiducial qDF approaches its optimum as well. 

\item \emph{Computational expense.} Overall the computation speed of this nested-grid approach is dominated (in descending order of importance) by a) the complexity of potential and action calculation, b) the $N_* \times N_\text{samples} + N_x^2 \times N_v^3$ actions required to be calculated per $p_\Phi$, c) the number of potential parameters and d) the number of DF parameters.
\end{itemize}

The second step samples the shape of the \pdf{} using a MCMC. Formally, calculating the \pdf{} on a fine grid like BR13 (e.g., with $K=11$ grid points in each dimension) would provide the same information. However the number of expensive \pdf{} evaluations scales as $K^{N_p}$. For a high-dimensional \pmodel{} ($N_p>4$), a MCMC approach might sample the \pdf{} much faster: We use \emph{emcee} by \citet{2013PASP..125..306F} and release the walkers very close to the best fit \pmodel{} found by the nested-grid search, which assures fast convergence in much less than $K^{N_p}$ \pdf{} evaluations. We also use the best fit \pmodel{} of the grid-search as fiducial qDF for the whole MCMC. In doing so, the normalisation varies smoothly with different $\pmodel{}$ and is slightly less sensitive to the accuracy in Equation \ref{eq:tracerdensity}.