\subsection{Fitting Procedure} \label{sec:fitting}

We search the $(p_\Phi,p_\text{DF})$ parameter space for the maximum of the likelihood in Eq. (\ref{eq:prob}) using a two-step procedure: The first step finds the approximate peak and width of the likelihood using a nested-grid search, while the second step samples the shape of the likelihood (or rather the posterior probability distribution) using a Monte-Carlo Markov Chain (MCMC) approach.

\paragraph{Fitting Step 1: Nested-grid search.} The $(p_\Phi,p_\text{DF})$ parameter space can be high-dimensional. To effectively minimizing the number of likelihood evaluations before finding its peak, we use a nested-grid approach:
\begin{itemize}

\item \emph{Initialization.} For $N$ free model parameters $M=(p_\Phi,p_\text{DF})$, we set up a sufficiently large initial grid with $3^N$ regular grid points.\footnote{To get a better feeling where in parameter space the true $p_\text{DF}$ parameters lie, we fit eq. (???) directly to the data. This gives a very good inital guess for $\sigma_{R,0}$ and $\sigma_{z,0}$. To improve the estimate for $h_R$, we fit eq. (???) only to stars within a thin wedge around $(R=0,z=0)$ and then apply the relation in fig. 5 in \citet{bov13} between the stars' measured scale length $h_R^\text{out}$ and the qDF tracer scale length $h_R^\text{in}=h_R$.}

\item  \emph{Evaluation.} We evaluate the likelihood at each grid-point. Because of the many conputationally expensive $\vect{x},\vect{v} \overset{p_\Phi}{\longrightarrow} \vect{J}$ transformations that have to be performed for each new set of $p_\Phi$ parameters, an outer loop iterates over the $p_\Phi$ parameters and pre-calculates the actions, while an inner loop evaluates the likelihood Eq. (\ref{eq:prob}) for all qDF parameters $p_\text{DF}$ with the actions in the given potential and (analogously to Fig. 9 in \citet{bov13}).

\item \emph{Iteration.} To find from the very sparse $3^N$ likelihood grid a new grid, that is more centered on the likelihood and has a width of order of the width of the likelihood, we proceed as follows: For each of the model parameter in $M$ we marginalize the likelihood by summing over the grid. If the resulting 3 points all lie within $4\sigma$ of a Gaussian, we fit a Gaussian to the 3 points and determine a new $4\sigma$ fitting range. Otherwise the grid point with the highest likelihood becomes the new fitting range. We proceed with iteratively evaluating the likelihood on finer and finer grids, until we have found a 4-sigma fit range in each of the model parameter dimensions.

\item \emph{The fiducial qDF.} For the above strategy to work properly, the action pre-calculations have to be independent of the choice of qDF parameters. This is clearly the case for the $N_j \times N_\text{error}$ [TO DO: explain $N_\text{error}$ ???]  stellar data actions $\vect{J}_i$. To calculate the normalisation in Eq. (\ref{eq:prob}), $N_\text{spatial}^2 \times N_\text{velocity}^3$ actions $\vect{J}_n$ are needed. Formally the spatial coordinates at which the $\vect{J}_n$ are calculated depend on the $p_\text{DF}$ parameters via the integration ranges in eq. (\ref{eq:tracerdensity}). To relax this dependence we instead use the same velocity integration limits in the likelihood calculations for all $p_\text{DF}$s in a given potential. This set of parameters, that sets the velocity integration range globally, $(\sigma_{R,0},\sigma_{z,0},h_{\sigma_R},h_{\sigma_z})$ in Eq. (???), is referred to as the "fiducial qDF". Using the same integration range in the density calculation for all qDFs at a given $p_\Phi$ makes the normalisation vary smoothly with different $p_\text{DF}$. Choosing a fiducial qDF that is very off from the true qDF can however lead to large biases. The optimal values for the fiducial qDF are the (yet unknown) best fit $p_\text{DF}$ parameters. We take care of this by setting, in each iteration step of the nested-grid search, the fiducial qDF simply to the $p_\text{DF}$ parameters of the central grid point.  As the nested-grid search approaches the best fit values, the fiducial qDF approaches automatically the optimal values as well. This is another advantage of the nested-grid search, because the result will not be biased by a poor choice of the fiducial qDF.

\item \emph{Speed Limitations.} Overall the computation speed of this nested-grid approach is dominated (in descending order of importance) by a) the complexity of potential and action calculation, b) the number $N_j \times N_\text{error} + N_\text{spatial}^2 \times N_\text{velocity}^3$ of actions to calculate, i.e. the number of stars, error samples and numerical accuracy of the normalisation calculations, c) the number of different potentials to investigate (i.e. the number of free potential parameters and number of grid points in each dimension) and d) the number of qDFs to investigate. The latter is also non-negligible, because for such a large number of actions the number of  qDF-function evaluations also take some time.
\end{itemize}

\paragraph{Fitting Step 2: MCMC.} After the nested-grid search is converged, the grid is centered at the peak of the likelihood and it's extent contains the $4\sigma$ confidence interval. To actually sample the full shape of the likelihood, we could do a grid search with much finer grid spacing (e.g. $K=11$ in each dimension). The number of grid points scales exponentially with number of free parameters $N$. For a large number of free parameters ($N>4$) a Monte Carlo Markov Chain (MCMC) approach might sample the likelihood (or rather the posterior probability distribution, which is the likelihood times some priors, see \S ????) much faster. We use \emph{emcee} by \citet{formanmackey??} and release the walkers very close to the likelihood peak found by the nested-grid search, which will assure fast convergence in much less than $K^N$ likelihood evaluations.
\\For a sufficiently high numerical accuracy in calculating the integrals in Eq. (\ref{eq:tracerdensity}) the current qDF parameters as each values can be used as integration ranges. To get reasonable results also for slightly lower accuracy, a single fiducial qDF can be used for all likelihood evaluations within the MCMC as well. As fiducial qDF we use the qDF parameters of the likelihood peak, found by the nested-grid search.
